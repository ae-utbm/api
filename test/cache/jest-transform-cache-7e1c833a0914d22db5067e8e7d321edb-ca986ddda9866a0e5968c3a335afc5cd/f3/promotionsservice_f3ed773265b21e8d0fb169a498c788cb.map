{"version":3,"names":["cov_13f1wk8x7c","actualCoverage","fs_1","s","__importDefault","require","path_1","core_1","common_1","config_1","schedule_1","images_1","promotion_picture_entity_1","promotion_entity_1","PromotionsService","exports","constructor","orm","configService","f","createNewPromotion","latest","findLatest","newPromotion","em","create","Promotion","number","persistAndFlush","findAll","promotions","find","fields","res","promotion","push","users","b","count","orderBy","findOne","NotFoundException","getUsers","user","getItems","id","updated_at","created_at","first_name","last_name","nickname","updateLogo","file","findOneOrFail","picture","init","buffer","mimetype","imageDir","join","get","extension","replace","filename","imagePath","default","mkdirSync","recursive","writeFileSync","isSquare","unlinkSync","HttpException","HttpStatus","BAD_REQUEST","path","createWriteStream","convertToWebp","PromotionPicture","size","byteLength","visibility","Date","getLogo","NOT_FOUND","deleteLogo","remove","flush","__decorate","Cron","UseRequestContext","Injectable","MikroORM","ConfigService"],"sources":["/Users/juknum/Documents/Code/AE/api/src/modules/promotions/promotions.service.ts"],"sourcesContent":["import fs from 'fs';\nimport { join } from 'path';\n\nimport { MikroORM, UseRequestContext } from '@mikro-orm/core';\nimport { HttpException, HttpStatus, Injectable, NotFoundException } from '@nestjs/common';\nimport { ConfigService } from '@nestjs/config';\nimport { Cron } from '@nestjs/schedule';\n\nimport { convertToWebp, isSquare } from '@utils/images';\n\nimport { PromotionResponseDTO } from './dto/promotion.dto';\nimport { PromotionPicture } from './entities/promotion-picture.entity';\nimport { Promotion } from './entities/promotion.entity';\nimport { BaseUserResponseDTO } from '../users/dto/base-user.dto';\n\n@Injectable()\nexport class PromotionsService {\n\tconstructor(private readonly orm: MikroORM, private readonly configService: ConfigService) {}\n\n\t/**\n\t * Create a new promotion each year on the 15th of July\n\t */\n\t@Cron('0 0 0 15 7 *')\n\t@UseRequestContext()\n\tasync createNewPromotion(): Promise<void> {\n\t\tconst latest = await this.findLatest();\n\t\tconst newPromotion = this.orm.em.create(Promotion, { number: latest.number + 1 });\n\n\t\tawait this.orm.em.persistAndFlush(newPromotion);\n\t}\n\n\t@UseRequestContext()\n\tasync findAll(): Promise<PromotionResponseDTO[]> {\n\t\tconst promotions = await this.orm.em.find(Promotion, {}, { fields: ['*', 'picture', 'users'] });\n\t\tconst res: PromotionResponseDTO[] = [];\n\n\t\tfor (const promotion of promotions) {\n\t\t\tres.push({ ...promotion, users: promotion.users.count() ?? 0 });\n\t\t}\n\n\t\treturn res;\n\t}\n\n\t@UseRequestContext()\n\tasync findLatest(): Promise<PromotionResponseDTO> {\n\t\tconst promotion = (\n\t\t\tawait this.orm.em.find(Promotion, {}, { orderBy: { number: 'DESC' }, fields: ['*', 'picture', 'users'] })\n\t\t)[0];\n\n\t\treturn {\n\t\t\t...promotion,\n\t\t\tusers: promotion.users.count() ?? 0,\n\t\t};\n\t}\n\n\t@UseRequestContext()\n\tasync findOne(number: number): Promise<PromotionResponseDTO> {\n\t\tconst promotion = await this.orm.em.findOne(Promotion, { number }, { fields: ['*', 'picture', 'users'] });\n\t\tif (!promotion) throw new NotFoundException(`Promotion with number ${number} not found`);\n\n\t\treturn {\n\t\t\t...promotion,\n\t\t\tusers: promotion.users.count() ?? 0,\n\t\t};\n\t}\n\n\t@UseRequestContext()\n\tasync getUsers(number: number): Promise<BaseUserResponseDTO[]> {\n\t\tconst promotion = await this.orm.em.findOne(Promotion, { number }, { fields: ['users'] });\n\t\tif (!promotion) throw new NotFoundException(`Promotion with number ${number} not found`);\n\n\t\tconst res: BaseUserResponseDTO[] = [];\n\n\t\tfor (const user of promotion.users.getItems()) {\n\t\t\tres.push({\n\t\t\t\tid: user.id,\n\t\t\t\tupdated_at: user.updated_at,\n\t\t\t\tcreated_at: user.created_at,\n\t\t\t\tfirst_name: user.first_name,\n\t\t\t\tlast_name: user.last_name,\n\t\t\t\tnickname: user.nickname,\n\t\t\t});\n\t\t}\n\n\t\treturn res;\n\t}\n\n\t@UseRequestContext()\n\tasync updateLogo({ number, file }: { number: number; file: Express.Multer.File }) {\n\t\tconst promotion = await this.orm.em.findOneOrFail(Promotion, { number });\n\t\tif (promotion.picture) await promotion.picture.init();\n\n\t\tconst { buffer, mimetype } = file;\n\t\tconst imageDir = join(this.configService.get<string>('files.promotions'), 'logo');\n\t\tconst extension = mimetype.replace('image/', '.');\n\t\tconst filename = `${promotion.number}${extension}`;\n\t\tconst imagePath = join(imageDir, filename);\n\n\t\t// write the file\n\t\tfs.mkdirSync(imageDir, { recursive: true });\n\t\tfs.writeFileSync(imagePath, buffer);\n\n\t\tif (!(await isSquare(imagePath))) {\n\t\t\tfs.unlinkSync(imagePath);\n\t\t\tthrow new HttpException('The logo must be square', HttpStatus.BAD_REQUEST);\n\t\t}\n\n\t\t// remove the old picture (if any)\n\t\tif (promotion.picture && promotion.picture.path && promotion.picture.path !== imagePath)\n\t\t\tfs.unlinkSync(promotion.picture.path);\n\n\t\t// convert to webp\n\t\tfs.createWriteStream(await convertToWebp(imagePath));\n\n\t\t// update the database\n\t\tif (!promotion.picture)\n\t\t\tpromotion.picture = this.orm.em.create(PromotionPicture, {\n\t\t\t\tfilename,\n\t\t\t\tmimetype,\n\t\t\t\tpath: imagePath.replace(extension, '.webp'),\n\t\t\t\tpromotion,\n\t\t\t\tsize: buffer.byteLength,\n\t\t\t\tvisibility: 'public',\n\t\t\t});\n\t\telse {\n\t\t\tpromotion.picture.filename = filename;\n\t\t\tpromotion.picture.mimetype = 'image/webp';\n\t\t\tpromotion.picture.updated_at = new Date();\n\t\t\tpromotion.picture.size = buffer.byteLength;\n\t\t\tpromotion.picture.path = imagePath.replace(extension, '.webp');\n\t\t}\n\n\t\tawait this.orm.em.persistAndFlush(promotion);\n\t}\n\n\t@UseRequestContext()\n\tasync getLogo(number: number) {\n\t\tconst promotion = await this.orm.em.findOneOrFail(Promotion, { number });\n\t\tif (!promotion.picture) throw new HttpException('This promotion has no logo', HttpStatus.NOT_FOUND);\n\n\t\tawait promotion.picture.init();\n\t\treturn promotion.picture;\n\t}\n\n\t@UseRequestContext()\n\tasync deleteLogo(number: number) {\n\t\tconst promotion = await this.orm.em.findOneOrFail(Promotion, { number });\n\t\tif (!promotion.picture) throw new HttpException('This promotion has no logo', HttpStatus.NOT_FOUND);\n\n\t\tawait promotion.picture.init();\n\t\tfs.unlinkSync(promotion.picture.path);\n\t\tawait this.orm.em.remove(promotion.picture).flush();\n\t}\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAAA;IAAAA,cAAA,YAAAA,CAAA;MAA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"}