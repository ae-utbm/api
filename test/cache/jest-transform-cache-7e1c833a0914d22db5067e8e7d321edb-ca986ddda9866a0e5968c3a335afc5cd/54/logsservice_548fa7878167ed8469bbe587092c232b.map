{"version":3,"names":["cov_llser1y8v","actualCoverage","core_1","s","require","common_1","schedule_1","nestjs_i18n_1","user_entity_1","users_service_1","responses_1","log_entity_1","LogsService","exports","constructor","usersService","i18n","orm","f","handleCron","em","nativeDelete","Log","created_at","$lt","Date","now","getUserLogs","id","b","parseInt","BadRequestException","idInvalid","type","User","user","findOne","logs","init","getItems","deleteUserLogs","removeAll","message","__decorate","Cron","UseRequestContext","Injectable","UsersService","I18nService","MikroORM"],"sources":["/Users/juknum/Documents/Code/AE/api/src/modules/logs/logs.service.ts"],"sourcesContent":["import type { I18nTranslations } from '@types';\n\nimport { MikroORM, UseRequestContext } from '@mikro-orm/core';\nimport { BadRequestException, Injectable } from '@nestjs/common';\nimport { Cron } from '@nestjs/schedule';\nimport { I18nService } from 'nestjs-i18n';\n\nimport { User } from '@modules/users/entities/user.entity';\nimport { UsersService } from '@modules/users/users.service';\nimport { idInvalid } from '@utils/responses';\n\nimport { Log } from './entities/log.entity';\n\n@Injectable()\nexport class LogsService {\n\tconstructor(\n\t\tprivate readonly usersService: UsersService,\n\t\tprivate readonly i18n: I18nService<I18nTranslations>,\n\t\tprivate readonly orm: MikroORM,\n\t) {}\n\n\t/**\n\t * Remove all logs that are older than 2 months each day at 7am\n\t */\n\t@Cron('0 0 7 * * *')\n\t@UseRequestContext()\n\tasync handleCron() {\n\t\tawait this.orm.em.nativeDelete(Log, { created_at: { $lt: new Date(Date.now() - 1000 * 60 * 60 * 24 * 60) } });\n\t}\n\n\tasync getUserLogs(id: number) {\n\t\tif (typeof id === 'string' && parseInt(id, 10) != id)\n\t\t\tthrow new BadRequestException(idInvalid({ i18n: this.i18n, type: User, id }));\n\n\t\tconst user = await this.usersService.findOne({ id });\n\n\t\tawait user.logs.init();\n\t\treturn user.logs.getItems();\n\t}\n\n\tasync deleteUserLogs(id: number) {\n\t\tconst user = await this.usersService.findOne({ id });\n\t\tawait user.logs.init();\n\t\tuser.logs.removeAll();\n\n\t\treturn { message: 'User logs deleted' };\n\t}\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;IAKA;IAAAA,aAAA,YAAAA,CAAA;MAAA,OAAAC,cAAA;IA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"}